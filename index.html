<script>
  let token = "", email = "", password = "";

  async function createAccountAndLogin() {
    try {
      const rand = Math.random().toString(36).substring(2, 10);
      email = `${rand}@mail.tm`;
      password = rand + rand;

      await fetch("https://api.mail.tm/accounts", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ address: email, password }),
      });

      const res = await fetch("https://api.mail.tm/token", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ address: email, password }),
      });

      const data = await res.json();
      token = data.token;
      document.querySelector(".email").textContent = email;

      // Try checking inbox every 5 seconds until it's ready
      const tryInbox = setInterval(() => {
        if (token) {
          clearInterval(tryInbox);
          checkInbox();
        }
      }, 5000);

    } catch (err) {
      document.getElementById("inbox").innerHTML = "<p>❌ Error creating temp mail. Try again later.</p>";
      console.error("Account creation error:", err);
    }
  }

  async function checkInbox() {
    const inbox = document.getElementById("inbox");
    inbox.innerHTML = "<p>🔄 Checking inbox...</p>";

    if (!token) {
      inbox.innerHTML = "<p>⏳ Still waiting for setup. Trying again shortly...</p>";
      return;
    }

    try {
      const res = await fetch("https://api.mail.tm/messages", {
        headers: { Authorization: `Bearer ${token}` },
      });

      const data = await res.json();
      inbox.innerHTML = "";

      if (!data["hydra:member"].length) {
        inbox.innerHTML = "<p>📭 No messages yet. Send one to your email.</p>";
        return;
      }

      for (let msg of data["hydra:member"]) {
        const res2 = await fetch(`https://api.mail.tm/messages/${msg.id}`, {
          headers: { Authorization: `Bearer ${token}` },
        });
        const full = await res2.json();

        inbox.innerHTML += `
          <div class="message">
            <b>From:</b> ${msg.from.address}<br>
            <b>Subject:</b> ${msg.subject}<br>
            <pre>${full.text || "No content"}</pre>
          </div>`;
      }

    } catch (err) {
      inbox.innerHTML = "<p>⚠️ Failed to load inbox. Try again.</p>";
      console.error("Inbox error:", err);
    }
  }

  function copyEmail() {
    navigator.clipboard.writeText(email).then(() => {
      alert("📋 Copied: " + email);
    });
  }

  createAccountAndLogin(); // Start app on load
</script>

<p class="email">Loading...</p>
<button onclick="copyEmail()">📋 Copy Email</button>
<button onclick="checkInbox()">🔄 Refresh Inbox</button>
<div id="inbox">
  <p>📭 Inbox is ready. Waiting for messages...</p>
</div>


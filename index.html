<script>
let token = "", address = "", password = "";

async function checkInbox() {
  const res = await fetch("https://api.mail.tm/messages", {
    headers: { Authorization: `Bearer ${token}` },
  });
  const data = await res.json();
  const inbox = document.getElementById("inbox");
  inbox.innerHTML = "";

  if (!data["hydra:member"].length) {
    inbox.innerHTML = "ðŸ“­ No messages yet.";
    return;
  }

  for (let msg of data["hydra:member"]) {
    const res2 = await fetch(`https://api.mail.tm/messages/${msg.id}`, {
      headers: { Authorization: `Bearer ${token}` },
    });
    const full = await res2.json();
    inbox.innerHTML += `<div><b>From:</b> ${msg.from.address}<br><b>Subject:</b> ${msg.subject}<br><pre>${full.text}</pre><hr></div>`;
  }
}

async function loadOrCreateAccount() {
  if (
    localStorage.getItem("email") &&
    localStorage.getItem("token") &&
    localStorage.getItem("password")
  ) {
    address = localStorage.getItem("email");
    token = localStorage.getItem("token");
    password = localStorage.getItem("password");
    document.querySelector(".email").textContent = address;
    checkInbox();
    return;
  }

  let rand = Math.random().toString(36).substring(2, 10);
  address = `${rand}@mail.tm`;
  password = rand + rand;

  await fetch("https://api.mail.tm/accounts", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ address, password }),
  });

  const res = await fetch("https://api.mail.tm/token", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ address, password }),
  });
  const data = await res.json();

  token = data.token;
  localStorage.setItem("email", address);
  localStorage.setItem("password", password);
  localStorage.setItem("token", token);
  document.querySelector(".email").textContent = address;
  checkInbox();
}

loadOrCreateAccount();
setInterval(checkInbox, 15000);
</script>
<p class="email">Loading...</p>
<div id="inbox">Checking inbox...</div>
